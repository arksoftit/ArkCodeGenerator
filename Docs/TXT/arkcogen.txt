# arkcogen.py es el archivo Main de la aplicación PySide6 ARKCodGen, que gestiona la interfaz gráfica y la lógica principal de la aplicación. Este archivo se encarga de inicializar la ventana principal, conectar los elementos de la interfaz con sus respectivas funciones y manejar las interacciones del usuario. Además, se integra con el módulo database_manager para gestionar la base de datos y con system_info para obtener información del sistema. También utiliza dialogos para mostrar diálogos personalizados, como el buscador de bases de datos. El archivo incluye un sistema de logging para registrar eventos importantes y errores en un archivo de log.
# Version 0.1.0 - 2026-02-15

import sys
from PySide6.QtWidgets import (QMainWindow, QApplication, QSizeGrip, QMessageBox, QWidget,
                               QLineEdit, QComboBox, QTextEdit, QDateEdit, QTimeEdit)
from PySide6.QtCore import Qt, QPropertyAnimation, QEasingCurve, QPoint, QDate, QTime
from PySide6.QtGui import QPixmap
from ui_Main import Ui_MainWindow
from database_manager import DatabaseManager
import system_info
from dialogos import BuscadorBaseDialog 
import logging

logging.basicConfig(
    filename="app.log",
    level=logging.DEBUG,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
class ArkApp(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
    
    # --- NUEVA INTEGRACIÓN DE BASE DE DATOS (Solo Inicialización) ---
        self.db_manager = DatabaseManager()
        self.db_manager.setup_database() # Crea la BD y las tablas si no existen
        logging.info("Base de datos ArkToolsBD.sqlite inicializada y tablas verificadas.")
        
    # ------------GESTION DE LA INTERFAZ GRAFICA------------
    # Eliminar barra de título y aplicar opacidad
        self.setWindowFlag(Qt.WindowType.FramelessWindowHint)
        self.setWindowOpacity(1)

        # SizeGrip (control para redimensionar la ventana)
        self.gripSize = 10
        self.grip = QSizeGrip(self)
        self.grip.resize(self.gripSize, self.gripSize)

        # Mover ventana (con PySide6, el evento debe ser conectado a un método de la clase)
        self.ui.frame_top.mouseMoveEvent = self.move_window
        self.ui.frame_top.mousePressEvent = self.mousePressEvent
        
        # Inicialmente, el botón de retorno está deshabilitado y oculto, ya que no hay navegación previa al inicio.
        self.ui.btn_return.setEnabled(False)
        self.ui.btn_return.hide()

        # Conectar botones de la barra superior
        self.ui.btn_minimize.clicked.connect(self.ctrl_bt_minimize)
        self.ui.btn_maximize.clicked.connect(self.ctrl_bt_maximize)
        self.ui.btn_restore.clicked.connect(self.ctrl_bt_restore)
        self.ui.btn_close.clicked.connect(lambda: self.close())
        # Ocultar el botón de restaurar al inicio
        self.ui.btn_restore.hide()
        # Conectar el botón del menú lateral
        self.ui.btn_menu.clicked.connect(self.move_menu)
        # self.ui.btn_info_hardware.clicked.connect(self.toggle_sub_hardware_menu)
        #self.ui.btn_operations.clicked.connect(self.toggle_operations_menu)
        
        # --- ESTADO INICIAL: DESHABILITAR FORMULARIOS ---
        self.set_form_enabled(self.ui.frm_form_company, False)
        self.set_form_enabled(self.ui.frm_form_clients, False)
        self.set_form_enabled(self.ui.frm_form_levels, False)
        self.set_form_enabled(self.ui.frm_form_code_generator, False)
        self.set_form_enabled(self.ui.frm_form_users, False)
        
        # LLAMADA OBLIGATORIA PARA QUE SE MUESTRE AL ABRIR
        self.update_status_bar()
        
        # --- VALORES POR DEFECTO: FECHA Y HORA ---
        # Esto busca todos los QDateEdit y QTimeEdit en toda la ventana y los actualiza
        for de in self.findChildren(QDateEdit):
            de.setDate(QDate.currentDate())

        for te in self.findChildren(QTimeEdit):
            te.setTime(QTime.currentTime())
        
        #Verificación de Base de Datos (Botón en Configuración)
        self.db_mgr = DatabaseManager(db_folder="arkcogendatabase", db_name="arkcogenDB.sqlite")
        self.ui.btn_config_sql_tools.clicked.connect(self.check_database_status)
        
        ##------------OPERACIONES EN EM MAIN MENU ------------
        # btn_return
        self.ui.btn_return.clicked.connect(self.return_to_home)
        #btn_customer
        self.ui.btn_customer.clicked.connect(lambda: self.confirm_navigation("page_frm_clients"))
        self.ui.btn_customer.clicked.connect(self.enable_return_button)
        #btn_config
        self.ui.btn_application_settings.clicked.connect(lambda: self.confirm_navigation("page_app_settings"))
        self.ui.btn_application_settings.clicked.connect(self.enable_return_button)
        #btn_levels
        self.ui.btn_levels.clicked.connect(lambda: self.confirm_navigation("page_frm_levels"))
        self.ui.btn_levels.clicked.connect(self.enable_return_button)
        #btn_ark_reports
        self.ui.btn_reports.clicked.connect(lambda: self.confirm_navigation("page_frm_reports"))
        self.ui.btn_reports.clicked.connect(self.enable_return_button)
        #btn_auto_code_generator
        self.ui.btn_auto_code_generator.clicked.connect(lambda: self.confirm_navigation("page_frm_code_generator"))
        self.ui.btn_auto_code_generator.clicked.connect(self.enable_return_button)
        #btn_company_settings
        self.ui.btn_company_settings.clicked.connect(lambda: self.confirm_navigation("page_frm_company"))
        self.ui.btn_company_settings.clicked.connect(self.enable_return_button)
        #btn_users
        self.ui.btn_users_settings.clicked.connect(lambda: self.confirm_navigation("page_frm_users"))
        self.ui.btn_users_settings.clicked.connect(self.enable_return_button)
        
        # Conexiones de botones de las barras de acciones
        # Conectar botón Incluir y Cancelar de company (Empresa)
        self.ui.btn_add_a_company.clicked.connect(self.action_include_company)
        self.ui.btn_save_a_company.clicked.connect(self.save_company)
        self.ui.btn_cancel_a_company.clicked.connect(self.action_cancel_company)
        # Clients
        # Conectar botón Incluir, Guardar y Cancelar de clients (Clients)
        self.ui.btn_add_clients.clicked.connect(self.action_include_clients)
        self.ui.btn_save_clients.clicked.connect(self.save_clients)
        self.ui.btn_cancel_clients.clicked.connect(self.action_cancel_clients)
        # Usuarios
        # Conectar botón Incluir y Cancelar de users (Usuarios)
        self.ui.btn_add_users.clicked.connect(self.action_include_users)
        self.ui.btn_save_users.clicked.connect(self.save_users)
        self.ui.btn_cancel_users.clicked.connect(self.action_cancel_users)
        # Niveles
        # Conectar botón Incluir y Cancelar de levels (Niveles)
        self.ui.btn_add_levels.clicked.connect(self.action_include_levels)
        self.ui.btn_save_levels.clicked.connect(self.save_levels)
        self.ui.btn_cancel_levels.clicked.connect(self.action_cancel_levels)

        
    # ------------FUNCIONES DE LA INTERFAZ GRAFICA------------
    # Permite guardar la posición del mouse cuando se presiona el botón izquierdo, para luego usar esa posición para mover la ventana.
    def move_window(self, event):
        """
        Permite mover la ventana cuando el user arrastra el mouse sobre el frame superior.
        """
        if not self.isMaximized():
            if event.buttons() == Qt.MouseButton.LeftButton:
                self.move(self.pos() + event.globalPosition().toPoint() - self.clickPosition)
                self.clickPosition = event.globalPosition().toPoint()
                event.accept()

        # Maximizar/restaurar la ventana si el mouse está cerca de la parte superior
        if event.globalPosition().y() <= 20:
            self.showMaximized()
        else:
            self.showNormal()
    
    def mousePressEvent(self, event):
        """
        Guarda la posición del mouse cuando se presiona el botón izquierdo.
        Esto es necesario para calcular el movimiento de la ventana en el método move_window.
        """
        if event.button() == Qt.MouseButton.LeftButton:
            self.clickPosition = event.globalPosition().toPoint()
            event.accept()
            

    # --- MÉTODOS DE UTILIDAD DE INTERFAZ ---
    def set_form_enabled(self, container, enabled=True):
        """Habilita o deshabilita widgets de entrada en un contenedor."""
        # Buscamos TODOS los widgets hijos que heredan de QWidget
        all_widgets = container.findChildren(QWidget)
        
        # Definimos la tupla de tipos que queremos controlar
        tipos_entrada = (QLineEdit, QComboBox, QTextEdit, QDateEdit, QTimeEdit)
        
        for widget in all_widgets:
            if isinstance(widget, tipos_entrada):
                widget.setEnabled(enabled)
                
    # Controles de la barra superior para minimizar, maximizar y restaurar la ventana.    
    def ctrl_bt_minimize(self):
        self.showMinimized()

    def ctrl_bt_restore(self):
        self.showNormal()
        self.ui.btn_restore.hide()
        self.ui.btn_maximize.show()

    def ctrl_bt_maximize(self):
        self.showMaximized()
        self.ui.btn_maximize.hide()
        self.ui.btn_restore.show()
    
    # --- MÉTODOS DE ACCIÓN (SLOTS) ---
    # ============GESTION DE EMPRESAS============
    def action_include_company(self):
        """Habilita los campos del formulario de Empresa."""
        self.set_form_enabled(self.ui.frm_a_company, True)
        self.ui.lineEdit_emp_code.setFocus()
    def action_cancel_company(self):
        if self.confirmar_accion_cancelar():
            self.clear_form_company()
            self.set_form_enabled(self.ui.frm_a_company, False)
    # ============GESTION DE CLIENTES============
    def action_include_clients(self):   
        self.set_form_enabled(self.ui.frm_clients, True)
        self.ui.lineEdit_clt_code.setFocus()
        logging.info("Formulario de clientes habilitado.")        
    def action_cancel_clients(self):
        if self.confirmar_accion_cancelar():
            self.clear_form_clients()
            self.set_form_enabled(self.ui.frm_clients, False)
        logging.info("Acción cancelar confirmada: Formulario limpiado y deshabilitado.")
    # ============GESTION DE USUARIOS============
    def action_include_users(self):
        self.set_form_enabled(self.ui.frm_users, True)
        self.ui.lineEdit_usr_code.setFocus()
    def action_cancel_users(self):
        if self.confirmar_accion_cancelar():
            self.clear_form_users()
            self.set_form_enabled(self.ui.frm_users, False)
    # ============GESTION DE NIVELES============
    def action_include_levels(self):
        self.set_form_enabled(self.ui.frm_levels, True)
        self.ui.lineEdit_lvs_description.setFocus()
    def action_cancel_levels(self):
        if self.confirmar_accion_cancelar():
            self.clear_form_levels()
            self.set_form_enabled(self.ui.frm_levels, False)
    
        
    def move_menu(self):
        """
        Muestra u oculta el menú principal (frame_menu).
        Asegura que los submenús (frame_sub_hardware y frame_operations) estén cerrados antes de abrir el menú principal.
        """
        # Cerrar los submenús antes de abrir el menú principal
        #self.ui.frame_sub_hardware.setMaximumWidth(0)
        #self.ui.frame_operations.setMaximumWidth(0)

        width = self.ui.frame_main_menu.maximumWidth()
        if width == 0:
            extender = 200  # Mostrar el menú principal
        else:
            extender = 0  # Ocultar el menú principal

        # Animación para el menú principal
        self.animacion = QPropertyAnimation(self.ui.frame_main_menu, b'maximumWidth')
        self.animacion.setDuration(300)
        self.animacion.setStartValue(width)
        self.animacion.setEndValue(extender)
        self.animacion.setEasingCurve(QEasingCurve.Type.InOutQuart)
        self.animacion.start()
        
    # Acceso a configuracion de la aplicación desde el menú principal
    def application_settings(self):
        """
        Muestra la página de configuración del sistema.
        """
        self.ui.sw_consoles.setCurrentWidget(self.ui.page_app_settings)
    
    def enable_return_button(self):
        """Activa y muestra el botón de retorno."""
        if not self.ui.btn_return.isVisible():
            self.ui.btn_return.show()
            self.ui.btn_return.setEnabled(True)
            logging.info("Botón btn_return activado.")
    def return_to_home(self):
        """
        ID=MDACG26020004: Solicita confirmación y regresa a la página de inicio.
        """
        # Diálogo de confirmación
        confirm = QMessageBox.question(
            self, 
            "Confirmación de navegación", 
            "¿Estás seguro de regresar al inicio?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
            QMessageBox.StandardButton.No
        )

        if confirm == QMessageBox.StandardButton.Yes:
            # 1. Regresar al stacked principal (sw_consoles) a la página home
            # Nota: Asegúrate que el nombre en el Designer sea page_home
            self.ui.sw_consoles.setCurrentWidget(self.ui.home_page)
            
            # 2. Ocultar y desactivar el botón de retorno
            self.ui.btn_return.setEnabled(False)
            self.ui.btn_return.hide()
            
            logging.info("Navegación: Usuario regresó al Inicio (Home).")
        else:
            logging.info("Navegación: Usuario canceló el regreso al Inicio.")

    # ------------------ MOSTRAR FORMULARIOS DE GESTION DE DATOS ------------------
    def confirm_navigation(self, target_page_name):
        """
        ID=MDACG26020004: Valida el cambio de sección.
        No pide confirmación si se sale de home_page o de page_app_settings.
        """
        # 1. Identificar la página actual en el stack principal
        current_page = self.ui.sw_consoles.currentWidget()
        
        # 2. Definir las páginas que NO requieren confirmación de salida (Zonas Seguras)
        # Agregamos page_app_settings a la lista de excepciones
        safe_pages = [self.ui.home_page, self.ui.page_app_settings]

        # 3. Validar si la página actual está fuera de las zonas seguras
        if current_page not in safe_pages:
            msg = "¿Epa, quieres cambiar de sección? Estás seguro? Ten en cuenta que perderás los cambios si no los has guardado correctamente."
            
            confirm = QMessageBox.question(
                self, "Confirmación de cambio", msg,
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.No
            )

            if confirm == QMessageBox.StandardButton.No:
                logging.info(f"Navegación hacia {target_page_name} cancelada por el usuario.")
                return  # Detenemos la ejecución
                
        # 4. Ejecución del cambio (Si viene de zona segura o si el usuario aceptó)
        logging.info(f"Navegando hacia: {target_page_name}")
        self.show_page(target_page_name)
        
        # 5. Gestión del botón de retorno (btn_return)
        # Solo se muestra si vamos a un formulario de gestión, no en home ni en settings
        if target_page_name.startswith("page_frm_"):
            self.ui.btn_return.show()
            self.ui.btn_return.setEnabled(True)
        else:
            # Si volvemos a home_page o entramos a settings, el botón de retorno se oculta
            self.ui.btn_return.hide()
    
    def show_page(self, page_name):
        """
        Muestra la página correspondiente validando su contenedor padre.
        """
        # 1. Obtener el objeto de la página desde la UI
        pagina = getattr(self.ui, page_name, None)
        
        if not pagina:
            logging.error(f"Página no encontrada: {page_name}")
            return

        # 2. Lógica para páginas que NO están en qsw_forms (como configuración)
        # Si la página es hija directa de sw_consoles
        if page_name == "page_app_settings":
            logging.info(f"Cambiando a consola de configuración: {page_name}")
            self.ui.sw_consoles.setCurrentWidget(pagina)
            return

        # 3. Lógica para formularios (anidados en qsw_forms)
        if page_name.startswith("page_frm_"):
            # Aseguramos que sw_consoles esté mostrando el contenedor de formularios
            if self.ui.sw_consoles.currentWidget() != self.ui.page_forms:
                self.ui.sw_consoles.setCurrentWidget(self.ui.page_forms)
            
            # Ahora sí, mostramos el formulario específico en el stack interno
            logging.info(f"Mostrando formulario en qsw_forms: {page_name}")
            self.ui.qsw_forms.setCurrentWidget(pagina)
        else:
            logging.error(f"Página no categorizada correctamente: {page_name}")
            
    # Método para mostrar el cuadro de diálogo de confirmación al cancelar una acción
    def confirmar_accion_cancelar(self):
        """Muestra el cuadro de diálogo y retorna True si el user confirma."""
        respuesta = QMessageBox.question(
            self, 
            "Confirmar Cancelación", 
            "¿Está seguro de cancelar la operación actual? Se perderán los cambios no guardados.",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
            QMessageBox.StandardButton.No
        )
        return respuesta == QMessageBox.StandardButton.Yes

            
    # --- ACTUALIZAR BARRA DE ESTADO CON INFO DEL SISTEMA ---
    
    def update_status_bar(self):
        try:
            # Extraemos los datos de tu sistema_info
            fecha   = system_info.get_date_audit()
            user = system_info.get_current_user()
            equipo  = system_info.get_machine_name()
            
            # Formateamos la cadena
            info_sesion = f" SESIÓN ACTIVA | Usuario: {user} | Equipo: {equipo} | Fecha: {fecha}"
            
            # Aplicamos al QLabel que mencionaste
            self.ui.footer__arkinfo.setText(info_sesion)
            
            # Log para verificar en consola/archivo si se ejecutó
            logging.info("Barra de estado actualizada correctamente.")
            
        except Exception as e:
            logging.error(f"Error al actualizar footer__arkinfo: {e}")
    
    # En la clase ArkApp dentro de arkcogen.py

    def check_database_status(self):
        """
        ID=MDACG26020005: Ejecuta validación técnica y despliega estadísticas detalladas.
        """
        import datetime
        import logging

        # 1. Preparar la consola de información
        self.ui.textEdit_info_settings.clear()
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.ui.textEdit_info_settings.append(f"<b>[{timestamp}] Iniciando validación de sistema...</b>")
        
        logging.info("Validación manual de base de datos iniciada.")

        # 2. Validación de infraestructura básica
        success, message = self.db_mgr.validate_infrastructure()
        
        if success:
            self.ui.textEdit_info_settings.append(f"<span style='color:green;'>[ÉXITO] {message}</span>")
            
            # 3. Obtener estadísticas (Llamada al método del Manager)
            stats = self.db_mgr.get_detailed_stats()
            
            if stats:
                html_table = """
                <br><table border='1' cellpadding='4' style='border-collapse: collapse; width: 100%; color: white;'>
                    <tr style='background-color: #333;'>
                        <th>Tabla</th>
                        <th>Columnas</th>
                        <th>Registros</th>
                    </tr>
                """
                for item in stats:
                    html_table += f"""
                    <tr>
                        <td>{item['tabla']}</td>
                        <td align='center'>{item['columnas']}</td>
                        <td align='center'>{item['registros']}</td>
                    </tr>
                    """
                html_table += "</table>"
                self.ui.textEdit_info_settings.append(html_table)
            
        else:
            self.ui.textEdit_info_settings.append(f"<span style='color:red;'>[ERROR] {message}</span>")
            logging.error(message)

        self.ui.textEdit_info_settings.ensureCursorVisible()
    
    # ============SECTION INSERT  DE DATOS
    
    # ============INSERT  DE DATOS EMPRESAS
    
    def save_company(self):
        """
        Recopila los datos del formulario frm_a_company e inserta
        un nuevo registro en la tabla ark_company.
        """
        try:
            # 1. Recolección de datos desde los widgets de PySide6
            # Nota: Usamos .strip() en textos para evitar espacios accidentales
            code            = self.ui.lineEdit_emp_code.text().strip()
            description     = self.ui.lineEdit_emp_description.text().strip()
            tax_id          = self.ui.lineEdit_emp_tax_id.text().strip()
            status          = self.ui.cmb_emp_ststus.currentIndex()             
            tax_address     = self.ui.textEdit_emp_tax_address.toPlainText().strip()
            local_address   = self.ui.textEdit_emp_local_address.toPlainText().strip()
            phone           = self.ui.lineEdit_emp_phone.text().strip()
            mobile          = self.ui.lineEdit_emp_mobile.text().strip()
            rep             = self.ui.lineEdit_emp_legal_representative.text().strip()
            id_rep          = self.ui.lineEdit_emp_legal_representative_id.text().strip()
            tel_rep         = self.ui.lineEdit_emp_contact_phone.text().strip()
            email_rep       = self.ui.lineEdit_emp_contact_email.text().strip()
            email_emp       = self.ui.lineEdit_emp_company_email.text().strip()
            tipo_taxpayer   = self.ui.cmb_emp_tipo_taxpayer.currentIndex()
            creation_date   = self.ui.dateEdit_creation_date.date().toString("yyyy-MM-dd")

            # Seccion de auditoría del sistema
            f_system  = system_info.get_date_audit()
            h_system  = system_info.get_time_audit()
            computer_name = system_info.get_machine_name()
            user    = system_info.get_current_user()
            last_f_systems = system_info.get_date_audit()
            last_h_systems = system_info.get_time_audit()
            last_computer_name = system_info.get_machine_name()
            last_user    = system_info.get_current_user()

            # 2. Validación básica de campos obligatorios
            if not code:
                QMessageBox.warning(self, "Validación", "El Código de la empresa es obligatorio.")
                return

            # 3. Preparación de la consulta SQL
            sql = """
            INSERT INTO ark_company (
                emp_Codigo, emp_Descripcion, emp_IDfiscal, emp_Status, emp_DireccionF, 
                emp_DireccionL, emp_Telefono1, emp_Telefono2, emp_Representante, emp_IDRepresentante, 
                emp_TelefonoContacto, emp_EmailContacto, emp_EmailEmpresa, emp_TipoContribuyente, emp_FechaCreacion,
                emp_SystemDate, emp_SystemTime, emp_NameMachine, emp_UserCreator,
                emp_LastUpdateDate, emp_LastUpdateTime, emp_LastMachine, emp_UserLastUpdate
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """

            # 4. Tupla de parámetros (DEBE seguir el mismo orden que el INSERT)
            params = (
                code, description, tax_id, status, tax_address, local_address, phone, mobile, rep, id_rep, tel_rep, 
                email_rep, email_emp, tipo_taxpayer, creation_date, f_system, h_system, computer_name, user,
                last_f_systems, last_h_systems, last_computer_name, last_user
            )

            # 5. Ejecución mediante el DatabaseManager
            exito = self.db_manager.execute_query(sql, params)

            if exito:
                logging.info(f"Empresa guardada exitosamente: {code}")
                QMessageBox.information(self, "Éxito", f"La Empresa '{code}' ha sido registrada correctamente.")
                self.clear_form_company() # Función que haremos a continuación
            else:
                QMessageBox.critical(self, "Error", "No se pudo guardar el registro en la base de datos.")
        except Exception as e:
            logging.error(f"Error crítico en save_company: {str(e)}")
            QMessageBox.critical(self, "Error de Sistema", f"Ocurrió un error inesperado:\n{e}")
    # ============LIMPEZA DE FORMULARIO EMPRESAS

    def clear_form_company(self):
        """
        Limpia todos los campos del formulario de clientes.
        """
        self.ui.lineEdit_emp_code.clear()
        self.ui.lineEdit_emp_description.clear()
        self.ui.lineEdit_emp_tax_id.clear()
        self.ui.cmb_emp_ststus.setCurrentIndex(0)
        self.ui.textEdit_emp_tax_address.clear()
        self.ui.textEdit_emp_local_address.clear()
        self.ui.lineEdit_emp_phone.clear()
        self.ui.lineEdit_emp_mobile.clear()
        self.ui.lineEdit_emp_legal_representative.clear()
        self.ui.lineEdit_emp_legal_representative_id.clear()
        self.ui.lineEdit_emp_contact_phone.clear()
        self.ui.lineEdit_emp_contact_email.clear()
        self.ui.lineEdit_emp_company_email.clear()
        self.ui.cmb_emp_tipo_taxpayer.setCurrentIndex(0)
        self.ui.dateEdit_creation_date.setDate(QDate.currentDate())
        self.ui.lineEdit_emp_code.setFocus()
        logging.info("Formulario de empresa limpiado.")
    
    # ============INSERT  DE DATOS CLIENTES    
    def save_clients(self):
        """
        Recopila los datos del formulario frm_form_clients e inserta
        un nuevo registro en la tabla ark_clients.
        """
        try:
            # 1. Recolección de datos desde los widgets de PySide6
            # Nota: Usamos .strip() en textos para evitar espacios accidentales
            code       = self.ui.lineEdit_clt_code.text().strip()
            description  = self.ui.lineEdit_clt_description.text().strip()
            tax_id    = self.ui.lineEdit_clt_idfiscaliscal.text().strip() # Según tu nombre con typo 'iscal'
            status       = self.ui.cmb_clt_status.currentIndex()             # INTEGER
            direccion_f  = self.ui.textEdit_clt_direccionF.toPlainText().strip()
            direccion_l  = self.ui.textEdit_clt_direccionL.toPlainText().strip()
            tel1         = self.ui.lineEdit_clt_telefono1.text().strip()
            tel2         = self.ui.lineEdit_clt_telefono2.text().strip()
            rep          = self.ui.lineEdit_clt_representante.text().strip()
            id_rep       = self.ui.lineEdit_clt_idrepresentante.text().strip()
            tel_cont     = self.ui.lineEdit_clt_telefonocontacto.text().strip()
            email_cont   = self.ui.lineEdit_clt_emailcontacto.text().strip()
            email_emp    = self.ui.lineEdit_clt_emailempresa.text().strip()
            tipo_cont    = self.ui.cmb_clt_tipocontribuyente.currentIndex()  # INTEGER
            origen       = self.ui.cmb_clt_origen.currentText()              # TEXT
            code_orig  = "" # Puedes vincularlo a un widget si lo creas luego
            creation_date   = self.ui.dateEdit_clt_fechacreacion.date().toString("yyyy-MM-dd")
            
            # Seccion de auditoría del sistema
            f_system  = system_info.get_date_audit()
            h_system  = system_info.get_time_audit()
            computer_name = system_info.get_machine_name()
            user    = system_info.get_current_user()
            last_f_systems = system_info.get_date_audit()
            last_h_systems = system_info.get_time_audit()
            last_computer_name = system_info.get_machine_name()
            last_user    = system_info.get_current_user()
            
            # 2. Validación básica de campos obligatorios
            if not code:
                QMessageBox.warning(self, "Validación", "El Código del cliente es obligatorio.")
                return

            # 3. Preparación de la consulta SQL
            sql = """
            INSERT INTO ark_clients (
                clt_Codigo, clt_Descripcion, clt_IDfiscal, clt_Status, clt_DireccionF, 
                clt_DireccionL, clt_Telefono1, clt_Telefono2, clt_Representante, clt_IDRepresentante, 
                clt_TelefonoContacto, clt_EmailContacto, clt_EmailEmpresa, clt_TipoContribuyente, clt_Origen, 
                clt_CodigoOrigen, clt_FechaCreacion,
                clt_SystemDate, clt_SystemTime, clt_NameMachine, clt_UserCreator,
                clt_LastUpdateDate, clt_LastUpdateTime, clt_LastMachine, clt_UserLastUpdate
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """

            # 4. Tupla de parámetros (DEBE seguir el mismo orden que el INSERT)
            params = (
                    code, description, tax_id, status, direccion_f, 
                    direccion_l, tel1, tel2, rep, id_rep, 
                    tel_cont, email_cont, email_emp, tipo_cont, origen, 
                    code_orig, creation_date,
                    f_system, h_system, computer_name, user, # Creación
                    last_f_systems, last_h_systems, last_computer_name, last_user  # Última actualización
                )

            # 5. Ejecución mediante el DatabaseManager
            exito = self.db_manager.execute_query(sql, params)

            if exito:
                logging.info(f"Cliente guardado exitosamente: {code}")
                QMessageBox.information(self, "Éxito", f"El cliente '{code}' ha sido registrado correctamente.")
                self.clear_form_clients() # Función que haremos a continuación
            else:
                QMessageBox.critical(self, "Error", "No se pudo guardar el registro en la base de datos.")

        except Exception as e:
            logging.error(f"Error crítico en save_clients: {str(e)}")
            QMessageBox.critical(self, "Error de Sistema", f"Ocurrió un error inesperado:\n{e}")
    
    # ============LIMPEZA DE FORMULARIO CLIENTES
    
    def clear_form_clients(self):
        """
        Resetea todos los campos del formulario de clientes a sus valores iniciales.
        """
        # 1. Limpiar QLineEdits y QTextEdits
        self.ui.lineEdit_clt_code.clear()
        self.ui.lineEdit_clt_description.clear()
        self.ui.lineEdit_clt_idfiscaliscal.clear()
        self.ui.lineEdit_clt_telefono1.clear()
        self.ui.lineEdit_clt_telefono2.clear()
        self.ui.lineEdit_clt_representante.clear()
        self.ui.lineEdit_clt_idrepresentante.clear()
        self.ui.lineEdit_clt_telefonocontacto.clear()
        self.ui.lineEdit_clt_emailcontacto.clear()
        self.ui.lineEdit_clt_emailempresa.clear()
        
        self.ui.textEdit_clt_direccionF.clear()
        self.ui.textEdit_clt_direccionL.clear()

        # 2. Resetear QComboBoxes al primer elemento (índice 0)
        self.ui.cmb_clt_status.setCurrentIndex(0)
        self.ui.cmb_clt_tipocontribuyente.setCurrentIndex(0)
        self.ui.cmb_clt_origen.setCurrentIndex(0)

        # 3. Resetear QDateEdit a la fecha actual
        self.ui.dateEdit_clt_fechacreacion.setDate(QDate.currentDate())

        # 4. (Opcional) Poner el foco de nuevo en el primer campo
        self.ui.lineEdit_clt_code.setFocus()
        
        logging.info("Formulario de clientes limpiado.")
        
    # ============INSERT  DE DATOS USUARIOS
    def save_users(self):
        """
        Recopila los datos del formulario frm_form_users e inserta
        un nuevo registro en la tabla ark_users.    
        """
        try:
            # 1. Recopilar datos del formulario de usuarios (similar a los anteriores)
            code        = self.ui.lineEdit_usr_code.text().strip()
            usuario     = self.ui.lineEdit_usr_username.text().strip()
            description = self.ui.lineEdit_usr_description.text().strip()
            status      = self.ui.cmb_usr_status.currentIndex()
            tel1        = self.ui.lineEdit_usr_phone.text().strip()
            email       = self.ui.lineEdit_usr_email.text().strip()
            cargo       = self.ui.lineEdit_usr_job_titles.text().strip()
            rol         = self.ui.lineEdit_usr_role.text().strip()            
            password    = self.ui.lineEdit_usr_password_in.text().strip()
            rpassword   = self.ui.lineEdit_usr_password_confirm.text().strip()
            
            # Seccion de auditoría del sistema
            f_system  = system_info.get_date_audit()
            h_system  = system_info.get_time_audit()
            computer_name = system_info.get_machine_name()
            user    = system_info.get_current_user()
            last_f_systems = system_info.get_date_audit()
            last_h_systems = system_info.get_time_audit()
            last_computer_name = system_info.get_machine_name()
            last_user    = system_info.get_current_user()

            # 2. Validar campos requeridos
            if not code or not description:
                QMessageBox.warning(self, "Advertencia", "Los campos Código y Descripción son obligatorios.")
                return

            # 3. Preparar SQL y parámetros
            sql = """
                INSERT INTO ark_users (
                    usr_Codigo, usr_username, usr_Descripcion, usr_Status, usr_Telefono, usr_Cargo, 
                    usr_Rol, usr_Emailuser, usr_Password,rpassword,
                    usr_systemdate, usr_systemtime, usr_namemachine, usr_usercreator,
                    usr_lastupdatedate, usr_lastupdatetime, usr_lastmachine, usr_userlastupdate
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
            
            f_system = QDate.currentDate().toString("yyyy-MM-dd")
            h_system = QTime.currentTime().toString("HH:mm:ss")
            computer_name = os.environ.get("COMPUTERNAME", "Desconocido")
            user = os.environ.get("USERNAME", "Desconocido")

            params = (
                code, usuario, description, status, tel1, 
                cargo, rol, email, password, rpassword,
                f_system, h_system, computer_name, user,
                last_f_systems, last_h_systems, last_computer_name, last_user
            )

            # 4. Ejecución mediante el DatabaseManager
            exito = self.db_manager.execute_query(sql, params)

            if exito:
                logging.info(f"Usuario guardado exitosamente: {code}")
                QMessageBox.information(self, "Éxito", f"El usuario '{code}' ha sido registrado correctamente.")
                self.clear_form_users() # Función que haremos a continuación
            else:
                QMessageBox.critical(self, "Error", "No se pudo guardar el registro en la base de datos.")

        except Exception as e:
            logging.error(f"Error crítico en save_users: {str(e)}")
            QMessageBox.critical(self, "Error de Sistema", f"Ocurrió un error inesperado:\n{e}")
    
    # ============LIMPEZA DE FORMULARIO USUARIOS
    
    def clear_form_users(self):
        """
        Resetea todos los campos del formulario de usuarios a sus valores iniciales.
        """
        # 1. Limpiar QLineEdits y QTextEdits
        self.ui.lineEdit_usr_code.clear()
        self.ui.lineEdit_usr_username.clear()
        self.ui.lineEdit_usr_description.clear()
        self.ui.lineEdit_usr_phone.clear()
        self.ui.lineEdit_usr_email.clear()
        self.ui.lineEdit_usr_job_titles.clear()
        self.ui.lineEdit_usr_role.clear()
        self.ui.lineEdit_usr_password_in.clear()
        self.ui.lineEdit_usr_password_confirm.clear()

        # 2. Resetear QComboBoxes al primer elemento (índice 0)
        self.ui.cmb_usr_status.setCurrentIndex(0)

        # 3. Resetear QDateEdit a la fecha actual
        self.ui.dateEdit_usr_fechacreacion.setDate(QDate.currentDate())

        # 4. (Opcional) Poner el foco de nuevo en el primer campo
        self.ui.lineEdit_usr_code.setFocus()
        
        logging.info("Formulario de usuarios limpiado.")
        
    # ============INSERT  DE DATOS NIVELES
    def save_levels(self):
        """
        Recopila los datos del formulario frm_form_levels e inserta
        un nuevo registro en la tabla ark_levels.    
        """
        try:
            # 1. Recopilar datos del formulario de niveles
            description     = self.ui.lineEdit_lvs_description.text().strip()
            descriptiontec  = self.ui.textEdit_lvs_descriptiontec.text().strip()
            type            = self.ui.cmb_lvs_type.currentText()
            digits          = self.ui.spinBox_lvs_Number_of_digits.value()
            separator       = self.ui.cmb_lvs_separator.text().strip()
            especiales      = self.ui.cb_lvs_Special_characters.toPlainText().strip()
            alphanumeric    = self.ui.cb_lvs_Special_alphanumeric.toPlainText().strip()
            status          = self.ui.cmb_lvs_status.currentIndex()
            parent          = self.ui.lineEdit_lvs_level_parente.text().strip()
            Code            = self.ui.lineEdit_lvs_code.text().strip()
            
            # Seccion de auditoría del sistema
            f_system  = system_info.get_date_audit()
            h_system  = system_info.get_time_audit()
            computer_name = system_info.get_machine_name()
            user    = system_info.get_current_user()
            last_f_systems = system_info.get_date_audit()
            last_h_systems = system_info.get_time_audit()
            last_computer_name = system_info.get_machine_name()
            last_user    = system_info.get_current_user()

            # 2. Validar campos requeridos
            if not description:
                QMessageBox.warning(self, "Advertencia", "El campo Descripción es obligatorio.")
                return

            # 3. Preparar SQL y parámetros
            sql = """
                INSERT INTO ark_levels (
                    lvs_Descripcion, lvs_descriptionTec, lvs_level_type, lvs_Number_of_digits,
                    lvs_Level_separator, lvs_Special_characters, lvs_Alphanumeric, lvs_Status,
                    lvs_level_parente, lvs_code
                    lvs_systemdate, lvs_systemtime, lvs_namemachine, lvs_usercreator,
                    lvs_lastupdatedate, lvs_lastupdatetime, lvs_lastmachine, lvs_userlastupdate
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
            
            f_system = QDate.currentDate().toString("yyyy-MM-dd")
            h_system = QTime.currentTime().toString("HH:mm:ss")
            computer_name = os.environ.get("COMPUTERNAME", "Desconocido")
            user = os.environ.get("USERNAME", "Desconocido")

            params = (
                description, descriptiontec, type, digits, separator,
                especiales, alphanumeric, status, parent, Code,
                f_system, h_system, computer_name, user,
                last_f_systems, last_h_systems, last_computer_name, last_user
            )

            # 4. Ejecución mediante el DatabaseManager
            exito = self.db_manager.execute_query(sql, params)

            if exito:
                logging.info(f"Nivel guardado exitosamente: {description}")
                QMessageBox.information(self, "Éxito", f"El nivel '{description}' ha sido registrado correctamente.")
                self.clear_form_levels() # Función que haremos
            else:
                QMessageBox.critical(self, "Error", "No se pudo guardar el registro en la base de datos.")
        except Exception as e:
            logging.error(f"Error crítico en save_levels: {str(e)}")
            QMessageBox.critical(self, "Error de Sistema", f"Ocurrió un error inesperado:\n{e}")
    # ============LIMPEZA DE FORMULARIO NIVELES
    def clear_form_levels(self):
        """
        Resetea todos los campos del formulario de niveles a sus valores iniciales.
        """
        # 1. Limpiar QLineEdits y QTextEdits
        self.ui.lineEdit_lvs_description.clear()
        self.ui.textEdit_lvs_descriptiontec.clear()
        self.ui.lineEdit_lvs_level_parente.clear()
        self.ui.lineEdit_lvs_code.clear()
        self.ui.cmb_lvs_separator.setCurrentIndex(0)
        self.ui.cb_lvs_Special_characters.clear()
        self.ui.cb_lvs_Special_alphanumeric.clear()

        # 2. Resetear QComboBoxes al primer elemento (índice 0)
        self.ui.cmb_lvs_type.setCurrentIndex(0)
        self.ui.cmb_lvs_status.setCurrentIndex(0)

        # 3. Resetear QSpinBox a su valor mínimo
        self.ui.spinBox_lvs_Number_of_digits.setValue(self.ui.spinBox_lvs_Number_of_digits.minimum())

        # 4. (Opcional) Poner el foco de nuevo en el primer campo
        self.ui.lineEdit_lvs_description.setFocus()
        
        logging.info("Formulario de niveles limpiado.")
    
      
        

if __name__ == "__main__":
    app = QApplication(sys.argv)
    ark_app = ArkApp()
    ark_app.show()
    sys.exit(app.exec())